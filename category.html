<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X Edge – Category</title>

  <link rel="preconnect" href="https://script.google.com">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .scrollbar-none::-webkit-scrollbar { display: none; }
    .scrollbar-none { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>

<body class="bg-gray-900 text-white">

  <!-- NAV -->
  <nav class="bg-gray-900/80 backdrop-blur-sm fixed w-full z-30 border-b border-gray-800">
    <div class="max-w-6xl mx-auto px-6 py-3 flex justify-between items-center">

      <a href="index.html" class="flex items-center gap-3">
        <img src="xedge-logo.png" class="w-8 h-8" alt="X Edge Logo">
        <span class="font-bold text-lg">X Edge</span>
      </a>

      <div class="hidden md:flex items-center gap-8">
        <a href="Explore.html" class="hover:text-blue-400">Explore</a>
        <a href="Categories.html" class="hover:text-blue-400">Categories</a>
        <a href="Join.html" class="bg-gradient-to-r from-blue-500 to-blue-600 px-4 py-2 rounded-full text-sm">
          Join Beta
        </a>
      </div>

      <!-- Mobile Back Button -->
      <a href="Categories.html" class="md:hidden text-gray-300 hover:text-blue-400">
        ← Back
      </a>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="pt-24 max-w-6xl mx-auto px-6 pb-24">
    <h1 id="categoryTitle" class="text-3xl font-bold mb-6">Loading...</h1>
    <section id="toolsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></section>
  </main>


<script>
// --------------------------------------------------------------
// FIX: Prevent browser back button infinite loading (BFCache)
// --------------------------------------------------------------
window.addEventListener("pageshow", (event) => {
  if (event.persisted) {
    window.location.reload();
  }
});


document.addEventListener("DOMContentLoaded", async () => {

  const RAW_URL = "https://script.google.com/macros/s/AKfycbxaA3BcQgW7PTFlSP9j4h16-p2us5IiuaYESUUpZiy8bObezI-nMUxXAC28tR15FU_U/exec";

  const CACHE_KEY = "xedge_tools_cache_v3";
  const CACHE_TIME_KEY = "xedge_tools_cache_time_v3";
  const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

  const params = new URLSearchParams(window.location.search);
  const selectedCat = params.get("cat");

  const titleEl = document.getElementById("categoryTitle");
  const container = document.getElementById("toolsContainer");

  if (!selectedCat) {
    titleEl.textContent = "Unknown Category";
    container.innerHTML = `<p class="text-gray-400">No category selected.</p>`;
    return;
  }

  titleEl.textContent = selectedCat;


  // --------------------------------------------------------------
  // Fetch tools with cache
  // --------------------------------------------------------------
  async function fetchTools() {
    try {
      const cache = localStorage.getItem(CACHE_KEY);
      const ts = Number(localStorage.getItem(CACHE_TIME_KEY));

      if (cache && ts && (Date.now() - ts < CACHE_TTL)) {
        return JSON.parse(cache);
      }

      const res = await fetch(RAW_URL + "?v=" + Date.now(), { cache: "no-store" });
      const data = await res.json();

      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      localStorage.setItem(CACHE_TIME_KEY, Date.now());

      return data;

    } catch (err) {
      return JSON.parse(localStorage.getItem(CACHE_KEY) || "[]");
    }
  }


  // --------------------------------------------------------------
  // Render Tools
  // --------------------------------------------------------------
  async function loadCategory() {

    container.innerHTML = `<p class='text-gray-400 col-span-full text-center py-6'>Loading tools…</p>`;

    const tools = await fetchTools();

    // Normalize tool fields
    const normalized = tools.map(t => ({
      name: t.name || t.title || "Unknown",
      description: t.description || t.short_description || "",
      category: t.category || "",
      link: t.link || "#",
      logo_url: t.logo_url || ""
    }));


    // --------------------------------------------------------------
    // Flexible Category Matching (Restores previous working behavior)
    // --------------------------------------------------------------
    const key = selectedCat.trim().toLowerCase().replace(/[\s_-]+/g, "");

    const filtered = normalized.filter(t => {
      const catKey = (t.category || "")
        .trim()
        .toLowerCase()
        .replace(/[\s_-]+/g, "");
      return catKey === key;
    });


    if (!filtered.length) {
      container.innerHTML =
        `<p class="text-gray-400">No tools found in this category.</p>`;
      return;
    }


    // Render tool cards
    container.innerHTML = filtered.map(tool => {

      let img = tool.logo_url;
      if (!img) img = "https://via.placeholder.com/200x200?text=X+Edge";

      if (img.includes("=s")) {
        img = img.replace(/=s\d+/, "=w200-h200");
      }

      return `
      <div class="bg-gray-800 border border-gray-700 p-6 rounded-xl hover:bg-gray-700 transition">

        <img src="${img}" loading="lazy"
             class="w-16 h-16 mx-auto mb-4 rounded object-cover"
             onerror="this.src='https://via.placeholder.com/200?text=No+Image'">

        <h3 class="text-lg font-semibold text-center">${tool.name}</h3>

        <p class="text-gray-300 text-sm text-center mt-2">
          ${tool.description.slice(0, 160)}
        </p>

        <div class="text-center mt-4">
          <a href="${tool.link}" target="_blank"
             class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg">
            Visit Tool →
          </a>
        </div>

      </div>
      `;
    }).join("");

  }


  // Start loading
  loadCategory();

});
</script>
 
  

</body>
</html>
